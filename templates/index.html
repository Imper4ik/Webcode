<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£—á–µ–±–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header>
    <h1>–£—á–µ–±–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h1>
    <p class="muted">–í—ã–±–∏—Ä–∞–π –∑–∞–¥–∞—á—É, –ø–∏—à–∏ –∫–æ–¥ –∏ –ø—Ä–æ–≤–µ—Ä—è–π —Ç–µ—Å—Ç–∞–º–∏. –ü–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ.</p>
  </header>

  <main>
    <section class="grid">
      <div>
        <h2>–¢–µ–º—ã –∏ —Å—Ç–∞—Ç—É—Å</h2>
        <div id="nodes" class="stack"></div>
      </div>
      <div>
        <h2>–†–µ–¥–∞–∫—Ç–æ—Ä</h2>
        <label>–ó–∞–¥–∞—á–∞:
          <select id="taskSelect"></select>
        </label>
        <pre id="taskDesc" class="desc"></pre>
        <textarea id="code" placeholder="–í—Å—Ç–∞–≤—å –∏–ª–∏ –ø—Ä–∞–≤—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–æ–¥"></textarea>
        <div class="row">
          <button id="run">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã</button>
          <button id="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
        </div>
        <pre id="output" class="log"></pre>
      </div>
    </section>
  </main>

<script>
function statusIcon(s){return s==='completed'?'‚úÖ':(s==='unlocked'?'üü°':'üîí')}

async function fetchGraph(){
  const r = await fetch('/api/knowledge-web');
  if(!r.ok) throw new Error('network');
  return r.json();
}
async function fetchTask(t){
  const r = await fetch('/api/task/'+encodeURIComponent(t));
  if(!r.ok) throw new Error('unknown task');
  return r.json();
}

let currentTask = null;

/** –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ —Ç–µ–º/–∑–∞–¥–∞—á. –ù–µ —Ç—Ä–æ–≥–∞–µ–º #output! */
async function render(){
  const g = await fetchGraph();
  const nodes = document.getElementById('nodes');
  const select = document.getElementById('taskSelect');
  nodes.innerHTML = '';
  select.innerHTML = '';

  g.nodes.forEach(n=>{
    const d = n.data; const box = document.createElement('div');
    box.className = 'node ' + (d.status==='locked'?'locked':'');
    box.innerHTML = `<div class="title">${statusIcon(d.status)} <strong>${d.label}</strong></div>
                     <div class="tasks">–ó–∞–¥–∞—á–∏: ${d.tasks.length? d.tasks.join(', ') : '‚Äî'}</div>`;
    nodes.appendChild(box);
    if(d.status!=='locked'){
      d.tasks.forEach(t=>{
        const o=document.createElement('option'); o.value=t; o.textContent=t + (g.completed.includes(t)?' (done)':'');
        select.appendChild(o);
      });
    }
  });

  if(!select.value && select.options.length) select.selectedIndex = 0;
  currentTask = select.value || null;
}

/** –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–æ–¥. resetOutput=true –æ—á–∏—â–∞–µ—Ç –ª–æ–≥. */
async function loadTask(resetOutput = false){
  const desc = document.getElementById('taskDesc');
  const code = document.getElementById('code');
  const select = document.getElementById('taskSelect');
  currentTask = select.value;
  if(!currentTask){ desc.textContent=''; code.value=''; return; }
  const t = await fetchTask(currentTask);
  desc.textContent = t.description || '';
  code.value = t.starter_code || '';
  if (resetOutput) document.getElementById('output').textContent='';
}

/** –°–º–µ–Ω–∞ –∑–∞–¥–∞—á–∏ –æ—á–∏—â–∞–µ—Ç –ª–æ–≥, —Ç.–∫. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è */
document.getElementById('taskSelect').addEventListener('change', () => loadTask(true));

/** –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ —Å—Ç–∏—Ä–∞–µ–º –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–æ–π */
document.getElementById('run').addEventListener('click', async()=>{
  const code = document.getElementById('code').value;
  const out = document.getElementById('output');
  if(!currentTask) return;
  out.textContent='–ó–∞–ø—É—Å–∫...';

  const r = await fetch('/run_code',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({code, task: currentTask})
  });
  const data = await r.json();

  if((data.stdout||'').includes('OK')){
    out.textContent='–¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã ‚úÖ\n'+(data.stdout||'');
    await fetch('/complete_task',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({username:'user1', task: currentTask})
    });
    await render();            // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Å—Ç–∞—Ç—É—Å—ã —Ç–µ–º/—Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
    // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É –≤—ã–±—Ä–∞–Ω–Ω–æ–π; –ª–æ–≥ –ù–ï –æ—á–∏—â–∞–µ–º
  } else {
    const details =
      data.details ||
      data.stderr ||
      data.compile_output ||
      data.message ||
      data.status ||
      data.stdout;
    out.textContent='–ü—Ä–æ–≤–∞–ª–µ–Ω–æ ‚ùå\n'+(typeof details==='string'? details : JSON.stringify(details, null, 2));
  }
});

/** –ü–æ–¥—Å–∫–∞–∑–∫–∞ ‚Äî —Å –¥–µ–±–∞—É–Ω—Å–æ–º, –Ω–µ —Å—Ç–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–æ–≤ */
document.getElementById('hint').addEventListener('click', async(ev)=>{
  const btn = ev.currentTarget; if(btn.disabled) return; btn.disabled = true;
  const out = document.getElementById('output');
  const code = document.getElementById('code').value;
  const desc = document.getElementById('taskDesc').textContent;

  const prev = out.textContent;
  out.textContent = (prev? prev+'\n\n':'') + '–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –ø–æ–¥—Å–∫–∞–∑–∫—É...';

  try{
    const r = await fetch('/api/get-hint',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({code, description: desc})
    });
    const data = await r.json();
    if(data.hint){
      out.textContent = (prev? prev+'\n\n':'') + '–ü–æ–¥—Å–∫–∞–∑–∫–∞: ' + data.hint + (data.cached?' (–∏–∑ –∫—ç—à–∞)':'');
    } else if(data.error==='rate_limited'){
      out.textContent = (prev? prev+'\n\n':'') + '–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π —á—É—Ç—å –ø–æ–∑–∂–µ.';
    } else {
      out.textContent = (prev? prev+'\n\n':'') + '–û—à–∏–±–∫–∞: ' + (data.details? JSON.stringify(data.details) : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
    }
  } finally {
    setTimeout(()=>{ btn.disabled = false; }, 1200);
  }
});

/** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —Ä–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ –∏ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É —Å –æ—á–∏—Å—Ç–∫–æ–π –ª–æ–≥–∞ */
(async () => {
  await render();
  if (currentTask) await loadTask(true);
})();
</script>
</body>
</html>
